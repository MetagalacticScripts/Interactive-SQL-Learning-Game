<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SQL Candy Quest üç≠</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(to bottom, #E6F0FA, #EAF7F0);
      font-family: 'Roboto', sans-serif;
      color: #333;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .sidebar {
      width: 100%;
      background: #FFFFFF;
      border-top: 1px solid #E0E0E0;
      padding: 2vh;
      box-sizing: border-box;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
      order: 2;
      overflow-y: auto;
      max-height: 40vh;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh;
      box-sizing: border-box;
      order: 1;
      overflow-y: auto;
    }
    h2, h3 {
      margin: 1vh 0;
      color: #4A90E2;
      font-weight: 500;
      font-size: clamp(1.5rem, 5vw, 2rem);
    }
    .time-display {
      font-size: clamp(1rem, 4vw, 1.5rem);
      margin: 1vh 0;
      color: #4A90E2;
    }
    #scoreboard {
      margin-top: 2vh;
      border: 1px solid #E0E0E0;
      border-radius: 1vh;
      padding: 1vh;
      background: #FAFAFA;
      box-shadow: 0 0.2vh 1vh rgba(0, 0, 0, 0.05);
    }
    #score-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #score-list li {
      padding: 0.5vh 0;
      border-bottom: 1px solid #E0E0E0;
      font-size: clamp(0.8rem, 3vw, 1.2rem);
    }
    h1 {
      font-size: clamp(2rem, 8vw, 3rem);
      color: #4A90E2;
      margin: 2vh 0;
      padding: 1vh;
      font-weight: 500;
    }
    .character-select button, .controls button {
      background: #4A90E2;
      color: #FFFFFF;
      border: none;
      padding: clamp(0.5vh, 1vh, 1rem) clamp(1.5vw, 3vw, 2rem);
      margin: 0.5vh;
      border-radius: 0.5vh;
      cursor: pointer;
      font-size: clamp(1rem, 3.5vw, 1.2rem);
      transition: background 0.3s ease, transform 0.2s ease;
      box-shadow: 0 0.2vh 0.6vh rgba(0, 0, 0, 0.1);
    }
    .character-select button:hover, .controls button:hover {
      background: #357ABD;
      transform: scale(1.1);
    }
    #hints-left {
      font-size: clamp(1rem, 3.5vw, 1.2rem);
      color: #4A90E2;
      margin: 0.5vh 0;
    }
    .board {
      width: clamp(80vw, 90vw, 70vw);
      height: clamp(40vh, 50vh, 80vh); /* Increased to fit all 20 tiles */
      background: #FFFFFF;
      margin: 1vh 0;
      border-radius: 1vh;
      box-shadow: 0 0.4vh 2vh rgba(0, 0, 0, 0.1);
      position: relative;
      border: 1px solid #E0E0E0;
      overflow: hidden;
    }
    .progress-bar {
      width: clamp(80vw, 90vw, 70vw);
      height: 1.5vh;
      background: #E0E0E0;
      border-radius: 0.5vh;
      margin: 0.5vh 0;
    }
    #progress {
      height: 100%;
      background: linear-gradient(to right, #B3E5FC, #B2DFDB, #B2F0B2);
      border-radius: 0.5vh;
      transition: width 0.5s ease;
    }
    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 0.5vh;
      width: 100%;
      height: 100%;
      padding: 1vh;
      box-sizing: border-box;
    }
    .tile {
      border-radius: 0.5vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(1.5rem, 5vw, 2rem);
      font-weight: bold;
      color: #333;
      box-shadow: 0 0.2vh 0.6vh rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
      background: #F0F4FF;
      aspect-ratio: 1 / 1;
    }
    .tile:hover {
      transform: translateY(-0.3vh);
      box-shadow: 0 0.6vh 1.2vh rgba(240, 244, 255, 0.3);
    }
    .start-tile {
      background: #FFD700;
      color: #333;
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      border: 1px solid rgba(255, 215, 0, 0.5);
    }
    .sticky-tile {
      background: #FFA500;
      font-size: clamp(1.8rem, 6vw, 2.5rem);
      border: 1px solid rgba(255, 165, 0, 0.5);
    }
    .castle-icon {
      font-size: clamp(2rem, 7vw, 3rem);
    }
    .active-tile {
      box-shadow: 0 0 1.5vh #4A90E2, 0 0 3vh #357ABD;
    }
    #player {
      font-size: clamp(2rem, 8vw, 3rem);
      position: absolute;
      transition: left 0.5s ease-in-out, top 0.5s ease-in-out, transform 0.5s ease-out;
      z-index: 10;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    #player.move {
      transform: scale(1.1);
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #FFFFFF;
      border-radius: 1vh;
      padding: 2vh;
      width: clamp(70vw, 80vw, 50vw);
      max-width: 600px;
      box-shadow: 0 1vh 4vh rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: popIn 0.3s ease-out;
    }
    @keyframes popIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .popup-content {
      background: #FAFAFA;
      border: 1px solid #E0E0E0;
      padding: 1.5vh;
      border-radius: 0.5vh;
      position: relative;
    }
    .popup h2 {
      color: #4A90E2;
      font-size: clamp(1.5rem, 5vw, 1.5rem);
      margin-bottom: 1vh;
      font-weight: 500;
    }
    #answer {
      width: 90%;
      min-height: 15vh;
      padding: 1vh;
      margin: 1vh 0;
      border: 1px solid #E0E0E0;
      border-radius: 0.5vh;
      font-size: clamp(0.8rem, 3vw, 1rem);
      font-family: 'Courier New', monospace;
      background: #FFFFFF;
      outline: none;
      overflow-y: auto;
      user-select: text;
      direction: ltr;
      white-space: pre-wrap;
    }
    #answer[contenteditable]:empty:before {
      content: attr(placeholder);
      color: #aaa;
    }
    .popup-buttons button {
      background: #4A90E2;
      color: #FFFFFF;
      border: none;
      padding: clamp(0.5vh, 1vh, 1rem) clamp(1vw, 2vw, 1rem);
      margin: 0.5vh;
      border-radius: 0.5vh;
      cursor: pointer;
      font-size: clamp(0.8rem, 3vw, 1rem);
      transition: background 0.3s;
    }
    .popup-buttons button:hover {
      background: #357ABD;
    }
    .close-button {
      position: absolute;
      top: 1vh;
      right: 1.5vh;
      background: transparent;
      border: none;
      font-size: clamp(1rem, 4vw, 1.5rem);
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }
    .close-button:hover {
      color: #4A90E2;
    }
    #message-popup .popup-content p {
      margin: 0;
      padding: 1vh 0;
      color: #555;
      white-space: pre-wrap;
      font-size: clamp(0.8rem, 3vw, 1rem);
    }
    #final-popup .popup-content {
      text-align: center;
    }
    #final-popup .confetti {
      font-size: clamp(1.5rem, 6vw, 2rem);
      margin-bottom: 1vh;
    }
    #final-popup input {
      width: 80%;
      padding: 1vh;
      margin: 1vh 0;
      border: 1px solid #E0E0E0;
      border-radius: 0.5vh;
      font-size: clamp(0.8rem, 3vw, 1rem);
    }
    @media (min-width: 768px) {
      .container {
        flex-direction: row-reverse;
      }
      .sidebar {
        width: 25vw;
        border-top: none;
        border-left: 1px solid #E0E0E0;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
        max-height: none;
        order: 0;
      }
      .main-content {
        order: 0;
      }
      .board {
        width: 70vw;
        height: 80vh; /* Adjusted to fit all 20 tiles in a 5x4 grid */
      }
      .progress-bar {
        width: 70vw;
      }
      .tiles {
        grid-template-columns: repeat(5, 1fr); /* Explicit 5 columns */
        grid-template-rows: repeat(4, 1fr);    /* Explicit 4 rows for 20 tiles */
        gap: 1vh;
      }
      .tile {
        font-size: clamp(2rem, 5vw, 3rem);
      }
      .start-tile {
        font-size: clamp(1.5rem, 4vw, 2rem);
      }
      .sticky-tile {
        font-size: clamp(2rem, 6vw, 3rem);
      }
      .castle-icon {
        font-size: clamp(2.5rem, 7vw, 4rem);
      }
      .controls {
        flex-wrap: nowrap;
      }
    }
    .sql-keyword {
      color: #C71585;
      font-weight: bold;
    }
    .sql-string {
      color: #32CD32;
    }
    .sql-number {
      color: #FF4500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <h1>Reach the Candy Castle!</h1>
      <div class="character-select">
        <button onclick="selectCharacter('üç≠')">Lollipop</button>
        <button onclick="selectCharacter('üç¨')">Candy</button>
        <button onclick="selectCharacter('üç´')">Chocolate</button>
      </div>
      <div class="board">
        <div id="tiles-container" class="tiles"></div>
        <div id="player">üç≠</div>
      </div>
      <div class="progress-bar"><div id="progress" style="width: 0%;"></div></div>
      <div class="controls">
        <button onclick="getQuestion('easy')">Easy Path</button>
        <button onclick="getQuestion('medium')">Medium Path</button>
        <button onclick="getQuestion('advanced')">Advanced Path</button>
        <button onclick="resetPlayer()">Reset</button>
      </div>
      <div id="hints-left">Hints Left: 3</div>
    </div>
    <div class="sidebar">
      <h2>SQL Candy Quest üç≠</h2>
      <div class="time-display" id="time-display">Time Elapsed: 0m 0s</div>
      <div id="scoreboard">
        <h3>Scoreboard</h3>
        <ul id="score-list"></ul>
      </div>
    </div>
  </div>
  <div id="question-popup" class="popup">
    <div class="popup-content">
      <button class="close-button" onclick="closePopup()">√ó</button>
      <h2>Sweet Challenge üç¨</h2>
      <p id="question-text"></p>
      <div id="answer" contenteditable="true" placeholder="Type your SQL query here..."></div>
      <div class="popup-buttons">
        <button onclick="submitAnswer()">Submit</button>
        <button onclick="showHint()">Hint</button>
        <button onclick="showDatabaseSchema()">Show Database Schema</button>
        <button onclick="showAnswer()">Show Answer</button>
      </div>
    </div>
  </div>
  <div id="message-popup" class="popup">
    <div class="popup-content">
      <button class="close-button" onclick="closeMessagePopup()">√ó</button>
      <p id="message-text"></p>
      <div class="popup-buttons">
        <button onclick="closeMessagePopup()">OK</button>
      </div>
    </div>
  </div>
  <div id="final-popup" class="popup">
    <div class="popup-content">
      <button class="close-button" onclick="closeFinalPopup()">√ó</button>
      <div class="confetti">üéâüéäüéâüéä</div>
      <p id="final-message"></p>
      <input type="text" id="player-name" placeholder="Enter your name">
      <div class="popup-buttons">
        <button onclick="submitFinalScore()">Submit</button>
      </div>
    </div>
  </div>
  <audio id="sticky-sound" preload="auto">
    <source src="data:audio/mpeg;base64,/+MYxAAAAANIAAAAAExBTUUzLjk4LjIA/+MYxDsAAABmQkVHSU4AAyAAAAAAR0lYQVQAAAAA/+MYxB8AAABQTEFZRQAAV2VsY29tZSB0byB0aGUgU29mdHdhcmUgRW5naW5lZXJpbmcgSW5zdGl0dXRlIQAA/+MYxCYAAADQTUVESVRBVElPTgAATWV0YWRhdGEgZm9yIHRoZSBTb2Z0d2FyZSBFbmdpbmVlcmluZyBJbnN0aXR1dGUAAAD/+MYxAwAAAExBTUUzAA==" type="audio/mpeg">
  </audio>
  <audio id="win-sound" preload="auto">
    <source src="data:audio/mpeg;base64,/+MYxAAAAANIAAAAAExBTUUzLjk4LjIA/+MYxDsAAABmQkVHSU4AAyAAAAAAR0lYQVQAAAAA/+MYxB8AAABQTEFZRQAAV2lubmluZyBzb3VuZCBmb3IgdGhlIFNvZnR3YXJlIEVuZ2luZWVyaW5nIEluc3RpdHV0ZQAA/+MYxCYAAADQTUVESVRBVElPTgAATWV0YWRhdGEgZm9yIHRoZSBTb2Z0d2FyZSBFbmdpbmVlcmluZyBJbnN0aXR1dGUAAAD/+MYxAwAAAExBTUUzAA==" type="audio/mpeg">
  </audio>
  <script>
    const totalSpaces = 20;
    let playerPosition = 0;
    let hintsLeft = 3;
    let playerIcon = "üç≠";
    let currentQuestion = null;
    let spacesToMove = 1;
    let moveCount = 0;
    let startTime = null;
    let timeInterval = null;
    const scoreboard = [];
    let tilePositions = [];
    const stickyTiles = new Set();
    let stickyAnswersNeeded = 0;
    let currentDifficulty = 'easy';
    const pastelColors = [
      '#F8C8DC', '#B3E5FC', '#D4A5E5', '#C8E6C9', '#FFD1B3',
      '#E6C9F0', '#A3D8F4', '#F5C6CB', '#B2F0B2', '#FFF5B7'
    ];
    const candyIcons = ['üç¨', 'üç´', 'üç≠', 'üç∞', 'üç™', 'üç©', 'üßÅ', 'üçÆ', 'üç¶'];

    const sqlQuestions = {
      easy: [
        { question: "Find all candy shops in 'Candyland'.", answer: "SELECT * FROM candy_shops WHERE location = 'Candyland';", result: { columns: ['shop_id', 'shop_name', 'location', 'rating'], rows: [{ shop_id: 1, shop_name: "Candy Haven", location: "Candyland", rating: 4.5 }] } },
        { question: "List all products with a price less than $5.", answer: "SELECT * FROM products WHERE price < 5;", result: { columns: ['product_id', 'product_name', 'category', 'price', 'stock_quantity'], rows: [
          { product_id: 1, product_name: "Lollipop", category: "Lollipop", price: 1.50, stock_quantity: 150 },
          { product_id: 2, product_name: "Chocolate Bar", category: "Chocolate", price: 2.00, stock_quantity: 200 },
          { product_id: 3, product_name: "Gummy Bears", category: "Gummy", price: 0.75, stock_quantity: 300 },
          { product_id: 4, product_name: "Hard Candy", category: "Hard Candy", price: 0.50, stock_quantity: 100 },
          { product_id: 5, product_name: "Caramel Chew", category: "Caramel", price: 1.25, stock_quantity: 75 }
        ]} },
        { question: "Get all sales from '2025-03-01'.", answer: "SELECT * FROM sales WHERE sale_date = '2025-03-01';", result: { columns: ['sale_id', 'shop_id', 'product_id', 'sale_date', 'quantity_sold', 'total_amount'], rows: [{ sale_id: 1, shop_id: 1, product_id: 1, sale_date: "2025-03-01", quantity_sold: 10, total_amount: 15.00 }] } },
        { question: "Select all products with stock quantity above 100.", answer: "SELECT * FROM products WHERE stock_quantity > 100;", result: { columns: ['product_id', 'product_name', 'category', 'price', 'stock_quantity'], rows: [
          { product_id: 1, product_name: "Lollipop", category: "Lollipop", price: 1.50, stock_quantity: 150 },
          { product_id: 2, product_name: "Chocolate Bar", category: "Chocolate", price: 2.00, stock_quantity: 200 },
          { product_id: 3, product_name: "Gummy Bears", category: "Gummy", price: 0.75, stock_quantity: 300 }
        ]} },
        { question: "List shops with a rating of 4 or higher.", answer: "SELECT * FROM candy_shops WHERE rating >= 4;", result: { columns: ['shop_id', 'shop_name', 'location', 'rating'], rows: [
          { shop_id: 1, shop_name: "Candy Haven", location: "Candyland", rating: 4.5 },
          { shop_id: 3, shop_name: "Choco Bliss", location: "Choco Land", rating: 4.9 },
          { shop_id: 5, shop_name: "Sweet Shop", location: "Sweet Town", rating: 4.0 }
        ]} }
      ],
      medium: [
        { question: "Find total quantity sold per product.", answer: "SELECT p.product_name, SUM(s.quantity_sold) FROM products p JOIN sales s ON p.product_id = s.product_id GROUP BY p.product_name;", result: { columns: ['product_name', 'SUM(s.quantity_sold)'], rows: [
          { product_name: "Lollipop", 'SUM(s.quantity_sold)': 10 },
          { product_name: "Chocolate Bar", 'SUM(s.quantity_sold)': 15 },
          { product_name: "Gummy Bears", 'SUM(s.quantity_sold)': 20 },
          { product_name: "Hard Candy", 'SUM(s.quantity_sold)': 50 },
          { product_name: "Caramel Chew", 'SUM(s.quantity_sold)': 30 }
        ]} },
        { question: "List shops and their total sales amount.", answer: "SELECT cs.shop_name, SUM(s.total_amount) FROM candy_shops cs JOIN sales s ON cs.shop_id = s.shop_id GROUP BY cs.shop_name;", result: { columns: ['shop_name', 'SUM(s.total_amount)'], rows: [
          { shop_name: "Candy Haven", 'SUM(s.total_amount)': 40.00 },
          { shop_name: "Sugar Delight", 'SUM(s.total_amount)': 30.00 },
          { shop_name: "Choco Bliss", 'SUM(s.total_amount)': 15.00 },
          { shop_name: "Gummy World", 'SUM(s.total_amount)': 37.50 }
        ]} },
        { question: "Get products with average sale amount over $20.", answer: "SELECT p.product_name, AVG(s.total_amount) FROM products p JOIN sales s ON p.product_id = s.product_id GROUP BY p.product_name HAVING AVG(s.total_amount) > 20;", result: { columns: ['product_name', 'AVG(s.total_amount)'], rows: [] } },
        { question: "Find top 3 highest-priced products.", answer: "SELECT product_name, price FROM products ORDER BY price DESC LIMIT 3;", result: { columns: ['product_name', 'price'], rows: [
          { product_name: "Chocolate Bar", price: 2.00 },
          { product_name: "Lollipop", price: 1.50 },
          { product_name: "Caramel Chew", price: 1.25 }
        ]} },
        { question: "List shops with no sales in 2025.", answer: "SELECT shop_name FROM candy_shops WHERE shop_id NOT IN (SELECT shop_id FROM sales WHERE sale_date LIKE '2025%');", result: { columns: ['shop_name'], rows: [] } }
      ],
      advanced: [
        { question: "Find the most popular product per shop by quantity sold.", answer: "SELECT cs.shop_name, p.product_name, SUM(s.quantity_sold) as total_sold FROM candy_shops cs JOIN sales s ON cs.shop_id = s.shop_id JOIN products p ON s.product_id = p.product_id GROUP BY cs.shop_name, p.product_name HAVING total_sold = (SELECT SUM(s2.quantity_sold) FROM sales s2 WHERE s2.shop_id = cs.shop_id GROUP BY s2.product_id ORDER BY SUM(s2.quantity_sold) DESC LIMIT 1);", result: { columns: ['shop_name', 'product_name', 'total_sold'], rows: [
          { shop_name: "Candy Haven", product_name: "Hard Candy", total_sold: 50 },
          { shop_name: "Sugar Delight", product_name: "Chocolate Bar", total_sold: 15 },
          { shop_name: "Choco Bliss", product_name: "Gummy Bears", total_sold: 20 },
          { shop_name: "Gummy World", product_name: "Caramel Chew", total_sold: 30 }
        ]} },
        { question: "List shops with sales exceeding average stock value.", answer: "SELECT cs.shop_name, SUM(s.total_amount) FROM candy_shops cs JOIN sales s ON cs.shop_id = s.shop_id GROUP BY cs.shop_name HAVING SUM(s.total_amount) > (SELECT AVG(p.price * p.stock_quantity) FROM products p JOIN sales s2 ON p.product_id = s2.product_id WHERE s2.shop_id = cs.shop_id GROUP BY s2.shop_id);", result: { columns: ['shop_name', 'SUM(s.total_amount)'], rows: [] } },
        { question: "Find products sold in all shops.", answer: "SELECT p.product_name FROM products p WHERE NOT EXISTS (SELECT cs.shop_id FROM candy_shops cs WHERE NOT EXISTS (SELECT 1 FROM sales s WHERE s.shop_id = cs.shop_id AND s.product_id = p.product_id));", result: { columns: ['product_name'], rows: [] } },
        { question: "Get shops with above-average sales per category.", answer: "SELECT cs.shop_name, p.category, SUM(s.total_amount) FROM candy_shops cs JOIN sales s ON cs.shop_id = s.shop_id JOIN products p ON s.product_id = p.product_id GROUP BY cs.shop_name, p.category HAVING SUM(s.total_amount) > (SELECT AVG(SUM(s2.total_amount)) FROM sales s2 JOIN products p2 ON s2.product_id = p2.product_id WHERE p2.category = p.category GROUP BY s2.shop_id);", result: { columns: ['shop_name', 'category', 'SUM(s.total_amount)'], rows: [] } }
      ]
    };
    const usedQuestions = {
      easy: new Set(),
      medium: new Set(),
      advanced: new Set(),
    };

    const mockDatabase = {
      candy_shops: [
        { shop_id: 1, shop_name: "Candy Haven", location: "Candyland", rating: 4.5 },
        { shop_id: 2, shop_name: "Sugar Delight", location: "Sugarville", rating: 3.8 },
        { shop_id: 3, shop_name: "Choco Bliss", location: "Choco Land", rating: 4.9 },
        { shop_id: 4, shop_name: "Gummy World", location: "Gummyville", rating: 3.2 },
        { shop_id: 5, shop_name: "Sweet Shop", location: "Sweet Town", rating: 4.0 }
      ],
      products: [
        { product_id: 1, product_name: "Lollipop", category: "Lollipop", price: 1.50, stock_quantity: 150 },
        { product_id: 2, product_name: "Chocolate Bar", category: "Chocolate", price: 2.00, stock_quantity: 200 },
        { product_id: 3, product_name: "Gummy Bears", category: "Gummy", price: 0.75, stock_quantity: 300 },
        { product_id: 4, product_name: "Hard Candy", category: "Hard Candy", price: 0.50, stock_quantity: 100 },
        { product_id: 5, product_name: "Caramel Chew", category: "Caramel", price: 1.25, stock_quantity: 75 }
      ],
      sales: [
        { sale_id: 1, shop_id: 1, product_id: 1, sale_date: "2025-03-01", quantity_sold: 10, total_amount: 15.00 },
        { sale_id: 2, shop_id: 2, product_id: 2, sale_date: "2025-03-02", quantity_sold: 15, total_amount: 30.00 },
        { sale_id: 3, shop_id: 3, product_id: 3, sale_date: "2025-03-03", quantity_sold: 20, total_amount: 15.00 },
        { sale_id: 4, shop_id: 1, product_id: 4, sale_date: "2025-03-04", quantity_sold: 50, total_amount: 25.00 },
        { sale_id: 5, shop_id: 4, product_id: 5, sale_date: "2025-03-05", quantity_sold: 30, total_amount: 37.50 }
      ]
    };

    function executeQuery(query) {
      try {
        const tables = {
          'candy_shops': mockDatabase.candy_shops,
          'products': mockDatabase.products,
          'sales': mockDatabase.sales
        };

        const keywords = query.toUpperCase().match(/\b(SELECT|FROM|WHERE|JOIN|GROUP|BY|HAVING|ORDER|LIMIT|NOT|IN|AND|OR|AS|SUM|AVG|COUNT|DISTINCT)\b/g) || [];
        if (!keywords.includes('SELECT') || !keywords.includes('FROM')) {
          return { error: "Invalid SQL query: Missing SELECT or FROM clause." };
        }

        let result = [...tables[query.match(/FROM\s+(\w+)/i)[1]] || []];

        // Handle JOIN
        const joinMatch = query.match(/JOIN\s+(\w+)\s+ON\s+(.+)/i);
        if (joinMatch) {
          const joinTable = joinMatch[1];
          const joinCondition = joinMatch[2];
          const [leftCol, rightCol] = joinCondition.split('=').map(col => col.trim());
          result = result.flatMap(row =>
            tables[joinTable].filter(joinRow =>
              eval(`row.${leftCol.split('.')[1]} === joinRow.${rightCol.split('.')[1]}`)
            ).map(joinRow => ({ ...row, ...joinRow }))
          );
        }

        // Handle WHERE
        const whereMatch = query.match(/WHERE\s+(.+)/i);
        if (whereMatch) {
          const condition = whereMatch[1].replace(/'([^']+)'/g, (match, p1) => `"${p1}"`);
          result = result.filter(row => {
            try {
              return eval(condition.replace(/(\w+)\.(\w+)/g, 'row.$2'));
            } catch (e) {
              return false;
            }
          });
        }

        // Handle GROUP BY and aggregation
        const groupByMatch = query.match(/GROUP\s+BY\s+(.+)/i);
        if (groupByMatch) {
          const groupByCols = groupByMatch[1].split(',').map(col => col.trim().split('.')[1]);
          const havingMatch = query.match(/HAVING\s+(.+)/i);
          const aggregates = {};
          const grouped = {};
          result.forEach(row => {
            const key = groupByCols.map(col => row[col]).join('|');
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(row);
          });
          result = Object.values(grouped).map(group => {
            const aggRow = {};
            groupByCols.forEach(col => aggRow[col] = group[0][col]);
            return aggRow;
          });

          const selectMatch = query.match(/SELECT\s+(.+?)(?:\s+FROM|\s+WHERE|\s+GROUP|\s+$)/i);
          if (selectMatch) {
            const selectClause = selectMatch[1].split(',').map(col => col.trim());
            selectClause.forEach(col => {
              const match = col.match(/(\w+)\((.+)\)/);
              if (match) {
                const aggFunc = match[1].toLowerCase();
                const aggCol = match[2].split('.')[1];
                result = result.map((row, index) => {
                  const group = grouped[Object.values(row).join('|')];
                  let value;
                  switch (aggFunc) {
                    case 'sum':
                      value = group.reduce((sum, r) => sum + (r[aggCol] || 0), 0);
                      break;
                    case 'avg':
                      value = group.reduce((sum, r) => sum + (r[aggCol] || 0), 0) / group.length;
                      break;
                    case 'count':
                      value = group.length;
                      break;
                    case 'max':
                      value = Math.max(...group.map(r => r[aggCol] || -Infinity));
                      break;
                    case 'min':
                      value = Math.min(...group.map(r => r[aggCol] || Infinity));
                      break;
                  }
                  return { ...row, [col]: value };
                });
              }
            });
          }

          if (havingMatch) {
            const havingCondition = havingMatch[1].replace(/'([^']+)'/g, (match, p1) => `"${p1}"`);
            result = result.filter(row => {
              try {
                return eval(havingCondition);
              } catch (e) {
                return false;
              }
            });
          }
        }

        // Handle ORDER BY
        const orderByMatch = query.match(/ORDER\s+BY\s+(.+)/i);
        if (orderByMatch) {
          const orderByCols = orderByMatch[1].split(',').map(col => {
            const [colName, dir] = col.trim().split(' ');
            return { col: colName.split('.')[1], dir: dir || 'ASC' };
          });
          result.sort((a, b) => {
            for (let { col, dir } of orderByCols) {
              if (a[col] < b[col]) return dir.toUpperCase() === 'ASC' ? -1 : 1;
              if (a[col] > b[col]) return dir.toUpperCase() === 'ASC' ? 1 : -1;
            }
            return 0;
          });
        }

        // Handle LIMIT
        const limitMatch = query.match(/LIMIT\s+(\d+)/i);
        if (limitMatch) {
          const limit = parseInt(limitMatch[1]);
          result = result.slice(0, limit);
        }

        // Extract selected columns
        const selectMatch = query.match(/SELECT\s+(.+?)(?:\s+FROM|\s+WHERE|\s+GROUP|\s+$)/i);
        let columns = [];
        if (selectMatch) {
          columns = selectMatch[1].split(',').map(col => {
            const match = col.trim().match(/(\w+)\((.+)\)/);
            return match ? `${match[1]}(${match[2].split('.')[1]})` : col.trim().split('.')[1] || '*';
          });
        }
        if (columns[0] === '*') {
          columns = Object.keys(result[0] || {});
        } else {
          result = result.map(row => {
            const newRow = {};
            columns.forEach(col => {
              const match = col.match(/(\w+)\((.+)\)/);
              if (match) {
                newRow[col] = row[col];
              } else {
                newRow[col] = row[col];
              }
            });
            return newRow;
          });
        }

        return { columns, rows: result };
      } catch (e) {
        return { error: `Query execution failed: ${e.message}` };
      }
    }

    window.onload = () => {
      generateTilePositions();
      generateTiles();
      startTime = Date.now();
      timeInterval = setInterval(updateTimer, 1000);
      loadScoreboard();
      setupSyntaxHighlighting();
      updateProgress();
      window.addEventListener('resize', () => {
        generateTilePositions();
        generateTiles();
        placePlayer();
      });
      document.getElementById('tiles-container').addEventListener('touchstart', handleTouchStart);
      document.getElementById('tiles-container').addEventListener('touchmove', handleTouchMove);
      document.getElementById('tiles-container').addEventListener('touchend', handleTouchEnd);
    };

    let touchStartX = 0;
    let touchStartY = 0;

    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    function handleTouchMove(e) {
      e.preventDefault();
    }

    function handleTouchEnd(e) {
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
        if (deltaX > 0 && playerPosition < totalSpaces - 1) {
          getQuestion('easy');
        }
      }
    }

    function generateTilePositions() {
      tilePositions = [];
      const board = document.querySelector('.board');
      const tilesContainer = document.getElementById('tiles-container');
      const boardRect = board.getBoundingClientRect();
      const tileElements = tilesContainer.children;
      if (tileElements.length === 0) return;
      for (let i = 0; i < totalSpaces; i++) {
        const tileRect = tileElements[i].getBoundingClientRect();
        const x = tileRect.left - boardRect.left + (tileRect.width - tileRect.width * 0.8) / 2;
        const y = tileRect.top - boardRect.top + (tileRect.height - tileRect.height * 0.8) / 2;
        tilePositions.push([x, y]);
      }
    }

    function generateTiles() {
      const container = document.getElementById("tiles-container");
      container.innerHTML = "";
      stickyTiles.clear();
      for (let i = 0; i < totalSpaces; i++) {
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.style.background = pastelColors[Math.floor(Math.random() * pastelColors.length)];
        if (i === 0) {
          tile.classList.add("start-tile");
          tile.innerText = "Start";
        } else if (i === totalSpaces - 1) {
          tile.style.background = "#FFFACD";
          tile.innerHTML = `<span class="castle-icon">üè∞</span>`;
        } else {
          if (Math.random() < 0.2 && i !== 0 && i !== totalSpaces - 1) {
            tile.classList.add("sticky-tile");
            tile.innerText = "üçØ";
            stickyTiles.add(i);
          } else {
            tile.innerText = candyIcons[Math.floor(Math.random() * candyIcons.length)];
          }
        }
        container.appendChild(tile);
      }
      setTimeout(() => {
        generateTilePositions();
        placePlayer();
      }, 0);
    }

    function resetPlayer() {
      playerPosition = 0;
      hintsLeft = 3;
      moveCount = 0;
      stickyAnswersNeeded = 0;
      startTime = Date.now();
      if (timeInterval) clearInterval(timeInterval);
      timeInterval = setInterval(updateTimer, 1000);
      document.getElementById("hints-left").innerText = `Hints Left: ${hintsLeft}`;
      document.getElementById("time-display").innerText = "Time Elapsed: 0m 0s";
      placePlayer();
      closePopup();
      closeMessagePopup();
      updateProgress();
      usedQuestions.easy.clear();
      usedQuestions.medium.clear();
      usedQuestions.advanced.clear();
    }

    function placePlayer() {
      const player = document.getElementById("player");
      const tiles = document.querySelectorAll(".tile");
      tiles.forEach((tile, index) => {
        tile.classList.toggle("active-tile", index === playerPosition);
      });
      if (tilePositions[playerPosition]) {
        const [x, y] = tilePositions[playerPosition];
        player.style.left = x + "px";
        player.style.top = y + "px";
        player.classList.remove("move");
        void player.offsetWidth;
        player.classList.add("move");
      }
      updateProgress();
    }

    function updateProgress() {
      const progress = (playerPosition / (totalSpaces - 1)) * 100;
      document.getElementById("progress").style.width = `${progress}%`;
    }

    function selectCharacter(icon) {
      playerIcon = icon;
      document.getElementById("player").innerText = icon;
      placePlayer();
    }

    function movePlayer(spaces) {
      moveCount++;
      const newPosition = Math.min(playerPosition + spaces, totalSpaces - 1);
      playerPosition = newPosition;
      placePlayer();
      if (playerPosition === totalSpaces - 1) {
        document.getElementById("win-sound").play();
        showFinalPopup();
      } else if (stickyTiles.has(playerPosition)) {
        document.getElementById("sticky-sound").play();
        if (stickyAnswersNeeded === 0) {
          stickyAnswersNeeded = 2;
          showMessage("You are stuck on a sticky honey tile. You must answer two questions correctly to proceed.");
          setTimeout(() => getQuestion(currentDifficulty), 1000);
        }
      }
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    function updateTimer() {
      const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsedSec / 60);
      const seconds = elapsedSec % 60;
      document.getElementById("time-display").innerText = `Time Elapsed: ${minutes}m ${seconds}s`;
    }

    function loadScoreboard() {
      const saved = localStorage.getItem("scoreboard");
      if (saved) {
        scoreboard.push(...JSON.parse(saved));
        updateScoreboardDisplay();
      }
    }

    function saveScoreboard() {
      localStorage.setItem("scoreboard", JSON.stringify(scoreboard));
    }

    function updateScoreboard(playerName) {
      const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
      const score = { name: playerName, time: elapsedSec, moves: moveCount };
      scoreboard.push(score);
      scoreboard.sort((a, b) => a.time - b.time);
      if (scoreboard.length > 10) scoreboard.pop();
      updateScoreboardDisplay();
      saveScoreboard();
    }

    function updateScoreboardDisplay() {
      const list = document.getElementById("score-list");
      list.innerHTML = "";
      scoreboard.forEach((entry, index) => {
        const li = document.createElement("li");
        li.innerText = `${index + 1}. ${entry.name} - ${Math.floor(entry.time / 60)}m ${entry.time % 60}s (${entry.moves} moves)`;
        list.appendChild(li);
      });
    }

    function getQuestion(difficulty) {
      if (playerPosition >= totalSpaces - 1) {
        showMessage("You have already reached the Candy Castle!");
        return;
      }

      currentDifficulty = difficulty;
      spacesToMove = difficulty === 'easy' ? 1 : difficulty === 'medium' ? 2 : 3;

      const pool = sqlQuestions[difficulty];
      const used = usedQuestions[difficulty];
      const available = pool.filter((q, idx) => !used.has(idx));
      if (available.length === 0) {
        used.clear();
        showMessage("All questions for this difficulty have been used. Resetting question pool.");
      }
      const updatedAvailable = pool.filter((q, idx) => !used.has(idx));
      if (updatedAvailable.length === 0) {
        showMessage("Error: No questions available after reset.");
        return;
      }
      const randIndex = Math.floor(Math.random() * updatedAvailable.length);
      currentQuestion = updatedAvailable[randIndex];
      const originalIndex = pool.indexOf(currentQuestion);
      used.add(originalIndex);

      document.getElementById("question-text").innerText = currentQuestion.question;
      const answerDiv = document.getElementById("answer");
      answerDiv.innerHTML = "";
      answerDiv.focus();
      document.getElementById("question-popup").style.display = "block";
    }

    function setupSyntaxHighlighting() {
      const answerDiv = document.getElementById("answer");
      answerDiv.addEventListener("input", function() {
        const text = this.innerText;
        const highlighted = text
          .replace(/\b(SELECT|FROM|WHERE|JOIN|GROUP|BY|HAVING|ORDER|LIMIT|NOT|IN|AND|OR|AS|SUM|AVG|COUNT|DISTINCT)\b/gi, '<span class="sql-keyword">$1</span>')
          .replace(/'[^']*'/gi, '<span class="sql-string">$&</span>')
          .replace(/\b\d+(\.\d+)?\b/gi, '<span class="sql-number">$&</span>');
        this.innerHTML = highlighted;
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(this);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      });
    }

    function submitAnswer() {
      if (!currentQuestion) {
        showMessage("Please select a question first.");
        return;
      }
      const answerDiv = document.getElementById("answer");
      const userQuery = answerDiv.innerText.trim();
      const correctResult = currentQuestion.result;
      const userResult = executeQuery(userQuery);

      if (userResult.error) {
        showMessage(`Error: ${userResult.error}`);
        return;
      }

      const isCorrect = JSON.stringify(userResult) === JSON.stringify(correctResult);
      if (isCorrect) {
        closePopup();
        if (stickyAnswersNeeded > 0) {
          stickyAnswersNeeded--;
          if (stickyAnswersNeeded > 0) {
            showMessage(`Correct! One more correct answer is required to pass the sticky honey tile. (${stickyAnswersNeeded} left)`);
            setTimeout(() => getQuestion(currentDifficulty), 1000);
          } else {
            showMessage("Correct! You have cleared the sticky honey tile. You may proceed on your next turn.");
          }
        } else {
          movePlayer(spacesToMove);
          showMessage(`Correct! You moved forward ${spacesToMove} space(s)!`);
        }
      } else {
        showMessage("Incorrect answer. Try again or use a hint! Your result doesn't match the expected output.");
      }
    }

    function showHint() {
      if (hintsLeft <= 0) {
        showMessage("No hints left!");
        return;
      }
      if (!currentQuestion) {
        showMessage("There is no active question to show a hint for.");
        return;
      }
      hintsLeft--;
      const hintText = currentQuestion.answer.split(" ").slice(0, Math.floor(currentQuestion.answer.split(" ").length / 2)).join(" ") + " ...";
      showMessage(`Hint: ${hintText}\nHints Left: ${hintsLeft}`);
      document.getElementById("hints-left").innerText = `Hints Left: ${hintsLeft}`;
    }

    function showDatabaseSchema() {
      showMessage(
        "candy_shops\n" +
        "  shop_id: INT PRIMARY KEY\n" +
        "  shop_name: VARCHAR(100) NOT NULL\n" +
        "  location: VARCHAR(100)\n" +
        "  rating: DECIMAL(2,1) CHECK (rating >= 0 AND rating <= 5)\n\n" +
        "products\n" +
        "  product_id: INT PRIMARY KEY\n" +
        "  product_name: VARCHAR(100) NOT NULL\n" +
        "  category: VARCHAR(50)\n" +
        "  price: DECIMAL(10,2)\n" +
        "  stock_quantity: INT\n\n" +
        "sales\n" +
        "  sale_id: INT PRIMARY KEY\n" +
        "  shop_id: INT\n" +
        "  product_id: INT\n" +
        "  sale_date: DATE\n" +
        "  quantity_sold: INT\n" +
        "  total_amount: DECIMAL(10,2)\n" +
        "  FOREIGN KEY (shop_id) REFERENCES candy_shops(shop_id)\n" +
        "  FOREIGN KEY (product_id) REFERENCES products(product_id)"
      );
    }

    function showAnswer() {
      if (!currentQuestion) {
        showMessage("There is no active question to show the answer for.");
        return;
      }
      showMessage(`The correct answer is:\n${currentQuestion.answer}`);
      closePopup();
      setTimeout(() => getQuestion(currentDifficulty), 1000);
    }

    function showMessage(message) {
      const popup = document.getElementById("message-popup");
      const messageText = document.getElementById("message-text");
      messageText.innerText = message;
      popup.style.display = "block";
    }

    function closePopup() {
      document.getElementById("question-popup").style.display = "none";
      currentQuestion = null;
    }

    function closeMessagePopup() {
      document.getElementById("message-popup").style.display = "none";
    }

    function showFinalPopup() {
      const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsedSec / 60);
      const seconds = elapsedSec % 60;
      document.getElementById("final-message").innerText = `Congratulations! You reached the Candy Castle in ${minutes}m ${seconds}s with ${moveCount} moves!`;
      document.getElementById("final-popup").style.display = "block";
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
      clearInterval(timeInterval);
    }

    function closeFinalPopup() {
      document.getElementById("final-popup").style.display = "none";
    }

    function submitFinalScore() {
      const playerName = document.getElementById("player-name").value.trim();
      if (playerName) {
        updateScoreboard(playerName);
        closeFinalPopup();
        resetPlayer();
      } else {
        showMessage("Please enter your name!");
      }
    }
  </script>
</body>
</html>